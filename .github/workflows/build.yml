name: Flutter APK CI
on:
  push:
    paths-ignore:
      - "**/*.md"
      - ".github/workflows/lock.yml"
  workflow_dispatch:
permissions:
  contents: write
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        persist-credentials: false
    - uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: '21'
    - uses: subosito/flutter-action@v2
      with:
        channel: stable
        cache: true
    - name: Ensure Android folder (safe)
      run: |
        [ -d android ] || flutter create --platforms=android . --no-pub
    - name: Git cleanup for pub git deps (strong)
      run: |
        set -e
        git config --global --unset-all "http.https://github.com.extraheader" || true
        git config --global --unset-all "http.https://github.com/.insteadOf" || true
    - name: Flutter pub get
      run: flutter pub get
    - name: Generate launcher icons if asset present
      run: |
        if [ -f assets/icon/icon.png ]; then
          flutter pub run flutter_launcher_icons
        else
          echo "assets/icon/icon.png not found, skipping launcher icon generation"
        fi
    - name: Build release APK (auto version)
      run: |
        flutter build apk --release \
          --build-number="$GITHUB_RUN_NUMBER" \
          --build-name="$(date +%Y.%m.%d).$GITHUB_RUN_NUMBER"
    - uses: actions/upload-artifact@v4
      with:
        name: apk-release
        path: build/app/outputs/flutter-apk/app-release.apk
